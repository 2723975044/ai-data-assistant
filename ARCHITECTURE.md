# 项目架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Web 前端     │  │  API 客户端   │  │  命令行工具   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       API 服务层                             │
│                    (FastAPI REST API)                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  /chat  /query  /status  /history  /clear           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      Agent 核心层                            │
│                  (DataAssistantAgent)                       │
│  ┌────────────────┐  ┌────────────────┐                    │
│  │  对话管理       │  │  任务执行       │                    │
│  │  (Memory)      │  │  (Tools)       │                    │
│  └────────────────┘  └────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     RAG 检索层                               │
│                   (RAGRetriever)                            │
│  ┌────────────────┐  ┌────────────────┐                    │
│  │  相似度检索     │  │  问答链         │                    │
│  │  (Retrieval)   │  │  (QA Chain)    │                    │
│  └────────────────┘  └────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐
│   向量数据库      │  │   大语言模型      │  │  关系数据库   │
│   (ChromaDB)     │  │   (LLM)          │  │  (MySQL)     │
│                  │  │                  │  │              │
│  - Chroma        │  │  - OpenAI        │  │  - MySQL     │
│  - FAISS         │  │  - 通义千问       │  │  - PostgreSQL│
│  - Qdrant        │  │  - 智谱AI        │  │  - MongoDB   │
└──────────────────┘  └──────────────────┘  └──────────────┘
```

## 核心组件

### 1. 数据层 (src/database/)
- **BaseDatabase**: 数据库基类，定义统一接口
- **MySQLDatabase**: MySQL 数据库连接
- **PostgreSQLDatabase**: PostgreSQL 数据库连接
- **MongoDBDatabase**: MongoDB 数据库连接
- **DatabaseFactory**: 数据库工厂类

**职责**:
- 管理数据库连接
- 执行查询操作
- 获取数据库 schema
- 提取示例数据

### 2. 文档处理层 (src/rag/)
- **DocumentProcessor**: 文档处理器
  - 数据库 schema 转文档
  - 示例数据转文档
  - 文本分块

**职责**:
- 将结构化数据转换为文本文档
- 文档分块和预处理
- 元数据管理

### 3. 向量存储层 (src/vectorstore/)
- **VectorStoreManager**: 向量数据库管理器
  - 支持 ChromaDB
  - 支持 FAISS
  - 支持 Qdrant

**职责**:
- 向量化文档
- 存储和检索
- 相似度搜索
- 持久化管理

### 4. RAG 检索层 (src/rag/)
- **RAGRetriever**: RAG 检索引擎
  - 相似度检索
  - 问答链构建
  - 上下文增强

**职责**:
- 检索相关文档
- 构建 QA Chain
- 生成答案并附带来源

### 5. LLM 层 (src/llm/)
- **LLMFactory**: 大模型工厂
  - OpenAI GPT
  - 阿里云通义千问
  - 智谱 AI ChatGLM
  - Anthropic Claude

**职责**:
- 统一 LLM 接口
- 多模型支持
- 参数配置

### 6. Agent 层 (src/agent/)
- **DataAssistantAgent**: 数据助手 Agent
  - 对话管理
  - RAG 集成
  - 任务执行

**职责**:
- 管理对话上下文
- 调用 RAG 检索
- 生成回答
- 维护对话历史

### 7. API 层 (src/api/)
- **FastAPI Application**
  - RESTful API
  - 数据模型
  - 请求/响应处理

**职责**:
- 提供 HTTP 接口
- 参数验证
- 异常处理
- CORS 支持

### 8. 工具层 (src/utils/)
- **config**: 配置管理
- **logger**: 日志系统

**职责**:
- 环境变量管理
- 日志记录
- 通用工具函数

## 数据流

### 初始化流程

```
1. 连接数据库
   ↓
2. 获取数据库 schema
   ↓
3. 处理为文档 (DocumentProcessor)
   ↓
4. 向量化并存储 (VectorStoreManager)
   ↓
5. 初始化 LLM
   ↓
6. 创建 RAG 检索器
   ↓
7. 创建 Agent
```

### 查询流程

```
用户问题
   ↓
Agent 接收
   ↓
RAG 检索相关文档
   ↓
构建增强的 Prompt
   ↓
LLM 生成回答
   ↓
返回结果 + 来源
```

## 技术栈

### 核心框架
- **LangChain**: LLM 应用框架
- **FastAPI**: Web 框架
- **Pydantic**: 数据验证

### 数据库
- **SQLAlchemy**: ORM
- **PyMySQL**: MySQL 客户端
- **psycopg2**: PostgreSQL 客户端
- **pymongo**: MongoDB 客户端

### 向量数据库
- **ChromaDB**: 向量数据库
- **FAISS**: 向量检索库

### LLM
- **OpenAI**: GPT 模型
- **DashScope**: 阿里云通义千问
- **ZhipuAI**: 智谱 AI

### 工具库
- **loguru**: 日志库
- **python-dotenv**: 环境变量
- **pyyaml**: YAML 解析

## 配置系统

采用分层配置:

1. **默认配置**: `src/utils/config.py`
2. **环境变量**: `.env` 文件
3. **运行时配置**: 通过参数覆盖

## 扩展性设计

### 1. 添加新的数据库支持
继承 `BaseDatabase` 类实现新的数据库连接器

### 2. 添加新的 LLM
在 `LLMFactory` 中添加新的创建方法

### 3. 添加新的向量数据库
在 `VectorStoreManager` 中添加新的类型支持

### 4. 自定义 Agent 行为
继承 `DataAssistantAgent` 或添加新的 Tools

## 性能优化

1. **缓存机制**: 缓存常见查询结果
2. **批处理**: 批量处理文档向量化
3. **异步处理**: API 层使用异步
4. **连接池**: 数据库连接池
5. **索引优化**: 向量数据库索引

## 安全考虑

1. **API Key 保护**: 环境变量存储
2. **SQL 注入防护**: 参数化查询
3. **访问控制**: API 认证（待实现）
4. **数据脱敏**: 敏感数据处理
5. **CORS 配置**: 跨域访问控制

## 测试策略

1. **单元测试**: 各模块独立测试
2. **集成测试**: 端到端测试
3. **API 测试**: FastAPI 测试客户端
4. **性能测试**: 压力测试

## 部署架构

```
┌──────────────────┐
│   负载均衡器      │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
┌───▼──┐  ┌──▼───┐
│ API  │  │ API  │  (多实例)
│ 服务  │  │ 服务  │
└───┬──┘  └──┬───┘
    │         │
    └────┬────┘
         │
┌────────▼─────────┐
│   向量数据库      │
│   (共享存储)      │
└──────────────────┘
```

## 监控和日志

1. **应用日志**: loguru
2. **API 监控**: FastAPI 中间件
3. **性能指标**: 响应时间、QPS
4. **错误追踪**: 异常日志

## 未来规划

1. ✅ 多数据库支持
2. ✅ 多 LLM 支持
3. ✅ RAG 检索
4. ✅ API 服务
5. ⏳ 用户认证
6. ⏳ 权限管理
7. ⏳ 对话历史持久化
8. ⏳ 前端界面
9. ⏳ 流式响应
10. ⏳ 工具调用（Function Calling）
